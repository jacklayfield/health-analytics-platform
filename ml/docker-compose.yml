version: '3.8'

services:
  # MLflow Tracking Server
  mlflow:
    env_file: .env
    build:
      context: ./ml
      dockerfile: Dockerfile.mlflow
    container_name: mlflow-server
    ports:
      - "5000:5000"
    volumes:
      - mlflow_data:/mlflow
    command: >
      mlflow server
        --backend-store-uri sqlite:///mlflow.db
        --default-artifact-root /mlflow/artifacts
        --host 0.0.0.0
        --port 5000
        --cors-allowed-origins "*"
        --allowed-hosts "*"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - health-net

  # ML Pipeline API Server
  ml-api:
    env_file: .env
    build:
      context: ./ml
      target: production
    container_name: ml-api-server
    ports:
      - "8000:8000"
    environment:
      - WAREHOUSE_DB_URI=${WAREHOUSE_DB_URI}
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
      - PYTHONPATH=/app
    volumes:
      - ./ml:/app
      - ./ml/models:/app/models
      - ./ml/logs:/app/logs
      - ./ml/artifacts:/app/artifacts
      - ./ml/config:/app/config
    working_dir: /app
    command: bash -c "pip install --no-cache-dir optuna[mlflow] optuna-integration[mlflow] mlflow pandas scikit-learn joblib psycopg2-binary fastapi uvicorn && uvicorn src.serving.model_server:create_app --host 0.0.0.0 --port 8000"
    networks:
      - health-net
    user: root

  # Jupyter Notebook for development
  jupyter:
    env_file: .env
    build:
      context: ./ml
      target: development
    container_name: ml-jupyter
    ports:
      - "8888:8888"
    environment:
      - WAREHOUSE_DB_URI=${WAREHOUSE_DB_URI}
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
    volumes:
      - ./ml:/app
      - jupyter_data:/home/jovyan/work
    command: >
      bash -c "pip install jupyter && jupyter notebook --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password=''"
    depends_on:
      - mlflow
    networks:
      - health-net

volumes:
  mlflow_data:
  postgres_data:
  jupyter_data:

networks:
  health-net:
    external: true
    name: health-net

